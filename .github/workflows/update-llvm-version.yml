name: Update LLVM Version

on:
    schedule:
        - cron: "0 0 * * 1" # Run every Monday
    workflow_dispatch: # Allow manual triggers

jobs:
    update-llvm-version:
        runs-on: ubuntu-latest
        permissions:
            contents: write
            pull-requests: write
        steps:
            - uses: actions/checkout@v5

            - name: Check latest LLVM version
              id: check-version
              run: |
                  # Get the latest LLVM version
                  LATEST_VERSION=$(curl -s https://api.github.com/repos/llvm/llvm-project/releases/latest | jq -r '.tag_name' | sed 's/llvmorg-//')
                  CURRENT_VERSION=$(grep -Po 'set\(LLVM_VERSION "(.*)"\)' CMakeLists.txt | grep -Po '".*"' | tr -d '"')

                  echo "Latest LLVM version: $LATEST_VERSION"
                  echo "Current LLVM version: $CURRENT_VERSION"

                  # Set output variables
                  echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
                  echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

                  # Check if versions are different
                  if [ "$LATEST_VERSION" != "$CURRENT_VERSION" ]; then
                    echo "need_update=true" >> $GITHUB_OUTPUT
                  else
                    echo "need_update=false" >> $GITHUB_OUTPUT
                  fi

            - name: Update CMakeLists.txt
              if: steps.check-version.outputs.need_update == 'true'
              run: |
                  LATEST_VERSION=${{ steps.check-version.outputs.latest_version }}
                  sed -i "s/set(LLVM_VERSION \".*\")/set(LLVM_VERSION \"$LATEST_VERSION\")/" CMakeLists.txt

                  # Calculate new SHA256 checksum
                  TARBALL_URL="https://github.com/llvm/llvm-project/releases/download/llvmorg-${LATEST_VERSION}/llvm-project-${LATEST_VERSION}.src.tar.xz"
                  echo "Downloading LLVM source to calculate checksum..."
                  TEMP_FILE=$(mktemp)
                  curl -L -o "$TEMP_FILE" "$TARBALL_URL"
                  SHA256=$(sha256sum "$TEMP_FILE" | cut -d' ' -f1)
                  rm "$TEMP_FILE"

                  # Update SHA256 checksum
                  sed -i "s/URL_HASH SHA256=[a-f0-9]*/URL_HASH SHA256=$SHA256/" CMakeLists.txt

            - name: Commit changes
              if: steps.check-version.outputs.need_update == 'true'
              run: |
                  git config --local user.email "github-actions[bot]@users.noreply.github.com"
                  git config --local user.name "GitHub Action"
                  git checkout -b update-llvm-version
                  git add CMakeLists.txt
                  git commit -m "chore: update LLVM version to ${{ steps.check-version.outputs.latest_version }}"
                  git push -f origin update-llvm-version

            - name: Create Pull Request
              if: steps.check-version.outputs.need_update == 'true'
              run: |
                  gh pr create \
                    --base main \
                    --head update-llvm-version \
                    --title "Update LLVM version to ${{ steps.check-version.outputs.latest_version }}" \
                    --body "Automatic LLVM version update

                  - Updated from ${{ steps.check-version.outputs.current_version }} to ${{ steps.check-version.outputs.latest_version }}
                  - Automatically updated SHA256 checksum

                  Generated by automated workflow."
              env:
                  GH_TOKEN: ${{ secrets.GH_TOKEN }}
